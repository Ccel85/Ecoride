
{% extends 'base.html.twig' %}

{% block title %}Profil utilisateur{% endblock %}

{% block body %}
<div class="container">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href= "{{ path('app_home') }}">Accueil</a></li>
        <li class="breadcrumb-item active" aria-current="page">Profil {{utilisateur.pseudo }}</li>
    </ol>
  </nav>
  {# Page profil #}
  <div class="page-profil d-flex flex-column align-items-center justify-content-center w-100 ">
    {% if id is defined and id > 0 %}
      <div class="card profil container m-4" >
        <div class="card-header row justify-content-evenly align-items-center">
          {% if utilisateur.imageName is not empty %}
            <div class="col-2 p-2">
              <a href="{{ path('app_profil',{'id': utilisateur.id}) }}">
                <img class="icon-hover rounded-circle" src="{{ vich_uploader_asset(utilisateur, 'imageFile') }}" 
                alt="profil" width="64" height="64" >
              </a>
            </div>
            {% else %}
            <div class="col-2 p-2">
                <a href="{{ path('app_profil') }}"><i class="bi bi-person-circle icon-hover" alt="Avatar" width="64" height="64"> </i></a>
            </div>
          {% endif %}
          <div class="col-10 text-center">
            <h3 class="card-title text-center">Mon profil</h3>
            <h3 class="card-text text-center">{{utilisateur.prenom|capitalize}}</h3>
            <p class="card-text text-center text-secondary fs-6">Crédits: {{utilisateur.credits}}</p>
          </div>
        </div>
        <!-- body -->
        <div class="card-body mt-3">
          <div class="row justify-content-around  ">
            <div class="infoUser col-md-6 col-12 " >
              <ul>
                <li>Membre depuis {{ utilisateur.createdAt | date ('Y')}} </li>
              {% if utilisateur.isConducteur == 1 and isPassager == 0 %}
                <li>Conducteur</li>
              {% elseif utilisateur.isConducteur == 1 and isPassager ==  1 %}
                <li>Conducteur et passager</li>
              {% elseif utilisateur.isConducteur == 0 and isPassager ==  1 %}
                <li>Passager</li>
              {% endif %}
                {% if rate > 0 %}
                  <li>
                    <i class="bi bi-star-fill star"> {{rate}}/5</i>
                  </li>
                {% endif %}
                <br>
                <!--voiture-->
                {% if voitureUser is not null %}
                  <hr>
                  {% for voiture in voitureUser %}
                  <li>Mon véhicule: {{ voiture.constructeur|capitalize }} {{ voiture.modele|capitalize }}</li>
                  <li>Immatriculé: {{ voiture.immat }} </li>
                  <li>Date de 1ère mise en circulation: {{ voiture.firstImmat|date('d-m-Y') }} </li>
                  <li>Place disponible: {{ voiture.nbrePlace }} </li>
                  {% endfor %}
                  {% else %}
                  <hr>
                  <li>Pas de véhicule enregistré.</li>
                {% endif %}
              </ul>
              <!--observations-->
                <hr>
                {% if utilisateur.observation > 0 %}
                  <p class="text-center text-decoration-underline"> Autre commentaire :</p>
                  {% for observation in observations %}
                    <p class="text-start">{{ observation}}</p>
                  {% endfor %}
                  {% else %}
                  <p>Il n'y a pas de d'observations</p>
                {% endif %}
            </div>
            <!--avis-->
            <div class="avis col-6">
              {% if commentairesUSer is empty %}
                <p class="text-center">Il n'y a pas d'avis.</p>
                {% else %}
                <h4 class="text-decoration-underline text-center"> Derniers avis clients:</h4>
                {% for commentaire in commentairesUSer %}
                {% if commentaire.isValid == true %}
                <div class="card mb-3 p-3  {% if loop.index > 3 %}d-none extra-comment{% endif %} ">
                  <div class="rate">
                    <i class="bi bi-star-fill star"> {{ commentaire.rateComments }}/5</i>
                  </div>
                  <div class="text-secondary fs-7">Le {{ commentaire.createdAt|date('d-m-Y') }}
                  </div>
                  <div>
                    <p>{{ commentaire.comments }}</p>
                  </div>
                {# <a href=""> Voir tout </a> #}
                </div>
                {% endif %}
                {% endfor %}
                {% if commentairesUSer|length > 3 %}
                  <div class="text-center mt-3">
                    <button id="show-all-comments" class="btn btn-outline-secondary">Voir tous les commentaires</button>
                  </div>
                {% endif %}
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% elseif app.user is empty %}
      <p>Aucun profil identifié</p>
    {% else %}
      {#Page profil détail #}
      <div class="card container m-4 profil" >
        <div class="card-header row justify-content-evenly align-items-center">
          {% if app.user.imageName is not empty %}
            <div class="col-2 p-2">
              {# <a href="{{ path('app_profil') }}">
              <img class=" avatar rounded-circle" src="{{asset('download/' ~ app.user.imageFile) }}" alt="" width="32" height="32" ></a> #}
              <div class="text-center">
                <a href="{{ path('app_profil',{'id': utilisateur.id}) }}">
                  <img class="rounded-circle" 
                  src="{{ vich_uploader_asset(utilisateur, 'imageFile') }}" 
                  alt="profil" width="100" height="100">
                </a>
              </div>
            </div>
            {% else %}
            <div class="col-2 p-2">
              <a href="{{ path('app_profil') }}">
              <i class="avatar bi bi-person-circle " alt="avatar" > </i></a>
            </div>
          {% endif %}
          <div class="col-8 text-center">
            <h3>Mon profil</h3>
            <h3>{{app.user.prenom|capitalize}}</h3>
            <p class="card-text text-secondary fs-6">Crédits: {{app.user.credits}}</p>
          </div>
          <div class="col-1 text-center">
            <a href="{{path('app_profil_update',{id: app.user.id}) }}" class="btn btn-success">
              <i class="bi bi-pencil-square" width="16" height="16"></i>
            </a>
          </div>
        </div>
        <!-- body -->
        <div class="card-body p-0 mt-3">
          <div class="row justify-content-around ">
            <div class="infoUser col-6" >
              <ul>
                <li>Membre depuis {{ app.user.createdAt | date ('Y')}}  </li>
              
              {% if app.user.isConducteur == 1 and isPassager == 0 %}
                <li>Conducteur</li>
              {% elseif app.user.isConducteur == 1 and isPassager ==  1%}
                <li>Conducteur et passager</li>
              {% elseif app.user.isConducteur == 0 and isPassager ==  1%}
                <li>Passager</li>
              {% endif %}
                
                {% if app.user and rate > 0 %}
                <li>
                <i class="bi bi-star-fill star"> {{rate}}/5</i>
                </li>
                {% endif %}
                </ul>
                <!--Voiture-->
                {% if voitureUser is not null %}
                  {% for voiture in voitureUser %}
                  <hr>
                  <div class="d-flex justify-content-between align-items-center flex-wrap">
                  <ul>
                    <li>Mon véhicule: {{ voiture.constructeur|capitalize }} {{ voiture.modele|capitalize }}</li>
                    <li>Immatriculé: {{ voiture.immat }} </li>
                    <li>Date de 1ère mise en circulation: {{ voiture.firstImmat|date('d-m-Y') }} </li>
                  </ul>
                  <a href="{{path('app_voiture_update',{id: voiture.id}) }}" class="btn btn-success">
                    <i class="bi bi-pencil-square"></i>
                  </a>
                  <a class="btn btn-danger" href="{{ path('app_voiture_remove', { 'id': voiture.id }) }}">
                    <i class="bi bi-trash3"></i>
                  </a>
                  </div>
                  {% endfor %}
                  <div class="text-center">
                  <a  href="{{path('app_voiture_new')}}">Ajouter un véhicule</a>
                  </div>
                {% else %}
                <hr>
                <p>Pas de véhicule enregistré.</p>
                {% endif %}
                <!-- observations-->
              <hr>
              {% if utilisateur.observation > 0 %}
                  <p class="text-start text-decoration-underline"> Autre commentaire :</p>
                  <div class="d-flex justify-content-between align-items-center"> 
                    <ul>
                    {% for observation in observations %}
                      <li class="text-start">{{ observation}}</li>
                      {% endfor %}
                    </ul>
                    <a href="{{ path('app_profil_update',{id: app.user.id})}}" class="btn btn-success">
                      <i class="bi bi-pencil-square"></i>
                    </a>
                  </div>
                {% else %}
                  <a href="{{ path('app_profil_update',{id: app.user.id}) }}">Ajouter des informations</a>
              {% endif %}
            </div>
            <!--avis-->
              <div class="avis col-6">
                {% if commentairesUSer is empty %}
                  <p>Il n'y a pas encore d'avis.</p>
                  {% else %}
                  <h4 class="text-decoration-underline text-center"> Derniers avis clients:</h4>
                {% for commentaire in commentairesUSer %}
                {% if commentaire.isValid == true %}
                <div class="card mb-3 p-3 {% if loop.index > 3 %}d-none extra-comment{% endif %}">
                  <div class="rate">
                    <i class="bi bi-star-fill star"> {{ commentaire.rateComments }}/5</i>
                  </div>
                  <div class="text-secondary fs-7">Le {{ commentaire.createdAt|date('d-m-Y') }}
                  </div>
                  <div>
                    <p>{{ commentaire.comments }}</p>
                  </div>
                {# <a href=""> Voir tout </a> #}
                </div>
                {% endif %}
                {% endfor %}
                {% if commentairesUSer|length > 3 %}
                  <div class="text-center mt-3">
                    <button id="show-all-comments" class="btn btn-outline-secondary">Voir tous les commentaires</button>
                  </div>
                {% endif %}
                {% endif %}
              </div>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
    <!--voyages-->
  <div class="MesVoyages col-12 p-0">
    {# Page profil#}
    {% if covoiturages is empty %}
      <p class="text-center">Il n'y a pas de voyage pour lequel vous participez.</p>
        {# si pas de covoiturage:bouton "créer un voyage" #}
        {% if utilisateur.isConducteur == true or (app.user and app.user.isConducteur == true)  %}
          <a href="{{path('app_covoiturage_new')}}" class="text-center">Créer un voyage</a>
        {% endif %}
    {% else %}
      <div class="d-flex justify-content-center align-items-center flex-column">
        <h3 class="text-decoration-underline"> Voyages enregistrés: </h3>
        {# Lien bouton créer voyage #}
        {% if app.user and utilisateur.isConducteur == true or (app.user and app.user.isConducteur == true)  %}
          <div class="d-flex container p-2 align-items-center">
            <i class="bi bi-plus-circle icon-hover" alt="plus Icon" width="32" height="32" class="rounded-circle"></i> 
            <a href="{{ path('app_covoiturage_new') }}" class="icon-hover px-2">Publier un voyage</a>
          </div>
        {% endif %}
      </div>
        {# Affichage des covoiturages #}
      {% for key, covoiturage in covoiturages %}
        {% set conducteur = conducteurs[key] %}
        <div class=" container m-4 ">
          <div class="voyage card d-flex flex-wrap justify-content-center">
            <div class="row align-items-center ">
              <div class="dateVoyage col-4 text-start ">
                <a  class="text-decoration-underline text-secondary m-2" href="{{path('app_covoiturage_id',{'id': covoiturage.id}) }}">Le {{ covoiturage.dateDepart|date('d-m-Y') }}</a>
                <br>
                <span class="m-2">Tarif: {{ covoiturage.prix }} € </span>
              </div>
              {% if app.user and covoiturage.conducteurId == app.user.id %}
                <div class="col-3 text-center">
                  <p class="fw-bold p-2">Mon voyage : </p>
                </div>
                {% set passagers = passager[covoiturage.id] %}
                  {% if passagers is not empty %}
                    <div class="passager col-4 d-flex text-center">
                    <p class="fw-bold p-2">Passager :</p>
                    {% for passager in passagers %}
                      <a href="{{ path('app_profil_id', {'id': passager.id}) }}"><img class="icon-hover rounded-circle" src="{{ vich_uploader_asset(passager, 'imageFile')}}" alt="profil_passager" width="40" height="40" ></a>
                    {% endfor %}
                    </div>
                  {% else %}
                  <div class="col-4 text-center">
                  <p class="fw-bold p-2" > Aucun passager </p>
                  </div>
                  {% endif %}
                {% else %}
                <div class="conducteur col-3 p-2 text-center">
                  <p class="fw-bold">Conducteur: <span >{{ conducteur.pseudo|capitalize }}</span></p>
                  {% if conducteur.imageName  is not empty %}
                    <a href="{{ path('app_profil_id', {'id': conducteur.id}) }}"><img class="icon-hover rounded-circle" src="{{ vich_uploader_asset(conducteur, 'imageFile') }}" alt="mail Icon" width="70" height="70" ></a>
                    {% else %}
                    <a href="{{ path('app_profil') }}"><img class="icon-hover rounded-circle" src="{{ asset('logo/Logo.png') }}" alt="logo" width="80" height="80" > </i></a>
                  {% endif %}
                </div>
              {% endif %}
              {# Gestion bouton validation voyage #}
              {% if app.user %}
                {# Pas conducteur:Bouton validation voyage actif #}
                {% if  covoiturage.id is not null 
                  and covoiturage.conducteurId != app.user.id   
                  and utilisateur.id == app.user.id  
                  and covoiturage.isArrived
                  and covoiturage.isValidateUser == false %}
                  <div class="boutons col-4 p-2 d-flex flex-column align-items-center text-decoration-underline ">
                    <p class="m-0">Valider votre voyage:</p>
                    <div data-controller ="sweet-alert" >
                      <a  id='validate' 
                      class="btn btn-success m-2" 
                      {# href="{{ path('app_covoiturage_validate', { 'id': covoiturage.id }) }}" #} 
                      data-url ="{{ path('app_covoiturage_validate', { 'id': covoiturage.id }) }}"
                      data-action = "click->sweet-alert#validateButton">
                        <i class="bi bi-check-lg"></i>
                      </a>
                    </div>
                  </div>
                {# Pas conducteur:si l'utilsateur à valider le voyage mais n'a pas mis d'avis 
                Bouton  laisser un avis et signaler un voyage#}
                {% elseif  covoiturage.id is not null 
                  and covoiturage.conducteurId != app.user.id 
                  and utilisateur.id == app.user.id  
                  and covoiturage.isArrived 
                  and covoiturage.isValidateUser == true
                  and covoiturage.isAvisUser == false
                  %}  
                  <div class="boutons col-auto p-2 d-flex flex-column align-items-center text-decoration-underline ">
                    <p class="m-0">Laisser un avis</p>
                    <div data-controller="sweet-alert">
                      <a  id='checkAvis' class="btn btn-success m-2" 
                      {# href="{{ path('app_covoiturage_validate', { 'id': covoiturage.id }) }}" #} 
                      data-url ="{{ path('app_avis_new',{ 'id': covoiturage.id }) }}"
                      data-action="click->sweet-alert#avisButton">
                        <i class="bi bi-check-lg"></i>
                      </a>
                    </div>
                  </div>
                  <div class="boutons col-auto p-2 d-flex flex-column align-items-center text-decoration-underline ">
                    <p class="m-0">Signaler un covoiturage</p>
                    <div data-controller="sweet-alert">
                      <a  id='signaler' class="btn btn-danger m-2" 
                          data-url ="{{ path('app_avis_signaler',{ 'id': covoiturage.id }) }}" 
                          data-action="click->sweet-alert#signalButton">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                      </a>
                    </div>
                  </div>
                {% endif %}
                {# Pas conducteur:si voyage validé et avis déposé
                check avis déposé #}
                {% if  covoiturage.id is not null 
                  and covoiturage.conducteurId != app.user.id 
                  and utilisateur.id == app.user.id  
                  and covoiturage.isArrived 
                  and covoiturage.isValidateUser == true
                  and covoiturage.isAvisUser == true
                  %}                    
                  <div class="boutons col-4 p-2 d-flex flex-column align-items-center text-decoration-underline ">
                    <p class="m-0">Avis déposé</p>
                    <i class="check bi bi-check-lg fs-1"></i>
                  </div>
                {% endif %}
                {# <div class="col-1"></div> #}
              {% endif %}
            </div>
                  <div class="row itineraire align-items-center p-3">
                    {# <div class="itineraire d-flex justify-content-evenly align-items-center"> #}
                    <div class="depart col-4 text-center">
                      <div class="fs-3 fw-bold">
                      {{ covoiturage.heureDepart|date('H:i') }}
                      </div>
                      <div class="fs-3 fw-bold">
                      {{ covoiturage.lieuDepart|capitalize }}
                      </div>
                    </div>
                    <div class="col-3">
                      <svg  viewBox="0 0 400 100" class="w-100 h-auto" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg">
                          <!-- Premier cercle -->
                          <circle cx="30" cy="50" r="20" stroke="#324D4D" fill="#FFFFFF" />
                          <!-- Ligne -->
                          <line x1="50" y1="50" x2="350" y2="50" stroke="#39B54E" stroke-width="2" />
                          <!-- Deuxième cercle -->
                          <circle cx="370" cy="50" r="20" stroke="#324D4D" fill="#FFFFFF" />
                      </svg>
                    </div>
                    <div class="arrivée col-4 text-center">
                      <div class="fs-3 fw-bold">
                      {{ covoiturage.heureArrivee|date('H:i') }}
                      </div>
                      <div class="fs-3 fw-bold">
                      {{ covoiturage.lieuArrivee|capitalize }}
                      </div>
                    </div>
                    {# Covoiturage du jour sur profil connecté #}
                    {% if app.user %}
                      {% if covoiturage.conducteurId is not null 
                        and covoiturage.conducteurId == app.user.id 
                        and covoiturage.dateAujourdhui %}
                        {# Affichage bouton stop #}
                        {% if covoiturage.isGo 
                          and covoiturage.isArrived == false %}
                          <div data-controller="sweet-alert">
                            <a id='carStop' 
                            data-url="{{ path('app_covoiturage_stop',{ 'id': covoiturage.id }) }}" 
                            data-action = "click->sweet-alert#stopButton"
                            class=" col-1 btn btn-warning m-2">
                              <i class="bi bi-sign-stop"></i></a> 
                          </div>
                          {#  Affichage bouton check #}
                          {% elseif covoiturage.isGo  
                          and covoiturage.isArrived  %}
                              <i class="col-1 check bi bi-check-lg fs-1"></i>
                        {% endif %}
                      {% endif %}
                      {# Covoiturage futur sur profil connecté 
                      !!!ajouter dateFuture dans les conditions #}
                      {% if covoiturage.conducteurId is not null 
                        and covoiturage.conducteurId == app.user.id 
                        and covoiturage.isGo == false and covoiturage.isArrived == false
                        and dateFuture is true
                        %}
                          <div class="boutons col-auto ">
                            <div data-controller="sweet-alert">
                              <a  id="trash_{{ covoiturage.id }}" 
                              class="btn btn-danger m-2" 
                              data-action = "click->sweet-alert#trashCovoiturage"
                              data-url="{{ path('app_covoiturage_remove', { 'id': covoiturage.id }) }}">
                                <i class="bi bi-trash3 "></i>
                              </a>
                              </div>
                            <a href="{{ path('app_covoiturage_update', { 'id': covoiturage.id }) }}" class="btn btn-success m-2">
                                <i class="bi bi-pencil-square "></i>
                            </a>
                          </div>
                      {% endif %}
                      {#  Covoiturage prévu aujourd'hui #}
                      {% if covoiturage.conducteurId is not null 
                        and covoiturage.conducteurId == app.user.id 
                        and covoiturage.dateAujourdhui 
                        and covoiturage.isGo == false %}
                        <div data-controller="sweet-alert" class="col-auto">
                          <a id='carGo' 
                          data-url="{{ path('app_covoiturage_go',{ 'id': covoiturage.id }) }}" 
                          class="btn custom-bg btn-success m-2"
                          data-action = "click->sweet-alert#goButton">
                            <i class="bi bi-car-front-fill "></i>
                          </a>
                        </div>
                      {% endif %}
                        {# sinon bouton pour annuler la participation au covoiturage #}
                      {% if  covoiturage.id is not null 
                        and covoiturage.conducteurId != app.user.id 
                        and covoiturage.dateFuture
                        and covoiturage.isGo == false  %}
                        <div class="boutons col-auto" data-controller = "sweet-alert">
                          <a id="trash" class="btn btn-danger m-2" 
                          data-url="{{ path('app_covoiturage_noparticipate', { 'id': covoiturage.id }) }}"
                          data-action = "click->sweet-alert#trashButton">
                            <i class="bi bi-trash3 "></i>
                          </a>
                        </div>
                      {% endif %}
                    {% endif %}
                  </div>
          </div>
        </div>
      {% endfor %}
    {% endif %}
  </div>
</div>
{% endblock %}
